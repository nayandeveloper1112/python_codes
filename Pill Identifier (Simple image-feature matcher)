# file: pill_identifier.py
# Requires: pip install opencv-python numpy
import cv2
import os
import numpy as np
from glob import glob

# Folder structure:
# dataset/
#   paracetamol.jpg
#   aspirin.jpg
# etc.

DATASET_DIR = "dataset"

def color_histogram(path):
    img = cv2.imread(path)
    img = cv2.resize(img, (200,200))
    hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
    hist = cv2.calcHist([hsv],[0,1],None,[50,60],[0,180,0,256])
    cv2.normalize(hist,hist)
    return hist.flatten()

def build_index():
    index = {}
    for filepath in glob(os.path.join(DATASET_DIR,"*.jpg")) + glob(os.path.join(DATASET_DIR,"*.png")):
        name = os.path.splitext(os.path.basename(filepath))[0]
        index[name] = color_histogram(filepath)
    return index

def identify(query_path, index):
    qh = color_histogram(query_path)
    scores = []
    for name, hist in index.items():
        # compare correlation
        score = cv2.compareHist(qh.astype('float32'), hist.astype('float32'), cv2.HISTCMP_CORREL)
        scores.append((name, score))
    scores.sort(key=lambda x: x[1], reverse=True)
    return scores[:5]

if __name__ == "__main__":
    print("Building index from dataset folder...")
    idx = build_index()
    q = input("Path to pill image: ")
    res = identify(q, idx)
    print("Top matches (name, similarity):")
    for r in res:
        print(r)
    print("Note: For reliable ID you need a labeled dataset and ML model.")
